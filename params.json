{
  "name": "Sky25",
  "tagline": "nginx varible cache",
  "body": "`nginx 变量之坑`\r\n\r\n\r\n   整过过程是这样的：在我的nginx模块里面会生成一个变量，然后这个变量的get_handler做的事情就是根据请求特征进行赋值该变量，\r\n在nginx的配置文件中使用if指令判断该变量与某个常量进行比较，如下：\r\n\r\n``` nginx \r\n\r\nserver {\r\n    ...\r\n    set $defaulet \"0\";\r\n    ngx_ab $upstream $cookie_uid $defaulet;\r\n    if ($upstream = \"0\") {\r\n        set $a \"0\";\r\n    }\r\n\r\n    location /t {\r\n        set $defaulet \"1\";\r\n        ngx_ab $upstream $cookie_uid $defaulet;\r\n        if ($upstream = \"1\") {\r\n            set $a \"1\";\r\n        }\r\n    }\r\n\r\n}\r\n\r\n```\r\n\r\n\r\n  \r\n  其中`upstream`这个变量是`ngx_ab`模块产生的一个变量，在server里面默认值被设置为0，在location里面默认值设置为1，然后一个请求\r\n会触发`ngx_ab`模块的变量`upstream`取默认值，但是最终奇怪的是在location中输出的变量a竟然是0；\r\n\r\n\r\n原因分析：\r\n=====\r\n\r\n首先看看`ngx_ab`模块设置`upstream`这个变量的get_handler：    \r\n\r\n```c\r\n\r\nstatic ngx_int_t\r\nngx_http_ab_upstream_variable(ngx_http_request_t *r, ngx_http_variable_value_t *v,\r\n    uintptr_t data)\r\n{\r\n    ...\r\n    v->valid = 1;\r\n    v->no_cacheable = 0;   //此处就是罪魁祸首，表示此变量可以缓存\r\n    v->not_found = 0;\r\n    ...\r\n}\r\n\r\n```\r\n\r\n\r\n然后在看看nginx的if指令取变量是如何取的，其核心代码如下：\r\n\r\n\r\n```c\r\n\r\n\r\nngx_http_variable_value_t *\r\nngx_http_get_flushed_variable(ngx_http_request_t *r, ngx_uint_t index)\r\n{\r\n    ngx_http_variable_value_t  *v;\r\n\r\n    v = &r->variables[index];\r\n\r\n    if (v->valid || v->not_found) {\r\n        if (!v->no_cacheable) {    //罪魁祸首，与其说罪魁祸首，还不如说是自己的无知\r\n            return v;\r\n        }\r\n\r\n        v->valid = 0;\r\n        v->not_found = 0;\r\n    }\r\n\r\n    return ngx_http_get_indexed_variable(r, index);\r\n}\r\n\r\n\r\n```\r\n\r\n分析总结\r\n=====\r\n\r\n   总的来说，我们自己设置的变量设置了其可缓存属性，然后nginx的if指令在取该变量的时候会判断\r\n该变量是否已经有值而且是否可以使用缓存中的值，若可以缓存则直接取上次计算出来的值。这也就是\r\n为啥 在我的location中取到的upstream变量的值还是0的原因；\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n欢迎一起交流学习 \r\n====\r\n \r\n在使用中有任何问题，欢迎反馈给我，可以用以下联系方式跟我交流\r\n\r\n* 邮件(1031379296#qq.com, 把#换成@)\r\n* QQ: 1031379296\r\n* weibo: [@王发康](http://weibo.com/u/2786211992/home)\r\n\r\n\r\nThx\r\n====\r\n\r\n* chunshengsterATgmail.com\r\n\r\n\r\nAuthor\r\n====\r\n* Linux\\nginx\\golang\\c\\c++爱好者\r\n* 欢迎一起交流  一起学习# \r\n* Others say good and Others good\r\n\r\n\r\n",
  "note": "Don't delete this file! It's used internally to help with page regeneration."
}